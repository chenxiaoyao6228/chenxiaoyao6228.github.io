(window.webpackJsonp=window.webpackJsonp||[]).push([[302],{859:function(t,a,s){"use strict";s.r(a);var e=s(7),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"前言"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),s("p",[t._v("业务需要在页面卸载之前发生某些请求结束某些状态，场景包括:")]),t._v(" "),s("ul",[s("li",[t._v("退出到其他页面")]),t._v(" "),s("li",[t._v("用户刷新或者关闭了页面")])]),t._v(" "),s("p",[t._v("场景一相对简单，但是场景二踩了一下坑。")]),t._v(" "),s("h2",{attrs:{id:"beforeunload"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#beforeunload"}},[t._v("#")]),t._v(" beforeunload")]),t._v(" "),s("p",[t._v("很自然想到的是监听 beforeunload 事件， 阻止页面直接关闭，用户通过点击确定/取消按钮，来决定是否不关闭/刷新当前页面。")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 添加beforeunload事件监听器")]),t._v("\nwindow"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"beforeunload"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 取消事件以阻止浏览器的默认行为")]),t._v("\n  event"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("preventDefault")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Chrome要求返回值来显示确认对话框")]),t._v("\n  event"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("returnValue "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br")])]),s("p",[t._v("但是会存在一些问题，就是关闭页面的弹窗不支持定制，且我们发送请求应该是不阻断用户使用的，产品自然不会接受我们这个方案")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/chenxiaoyao6228/cloudimg@main/2023/before-unload-chrome-snapshot.png",alt:""}})]),t._v(" "),s("p",[t._v("完整的 demo 请看 👉 "),s("a",{attrs:{href:"https://chenxiaoyao6228.github.io/html-preview/?https://github.com/chenxiaoyao6228/fe-notes/blob/main/%E8%B8%A9%E5%9D%91%E6%B1%87%E6%80%BB/_demo/page-before-unload/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("在线效果预览"),s("OutboundLink")],1),t._v(", 查看示例代码请点击"),s("RouterLink",{attrs:{to:"/docs/踩坑汇总/_demo/page-before-unload/index.html"}},[t._v("此处")])],1),t._v(" "),s("p",[t._v("但浏览器在页面卸载后会 kill 掉发送的请求，并不可靠。")]),t._v(" "),s("h2",{attrs:{id:"为什么浏览器会在页面卸载后取消请求"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#为什么浏览器会在页面卸载后取消请求"}},[t._v("#")]),t._v(" 为什么浏览器会在页面卸载后取消请求")]),t._v(" "),s("p",[t._v("问题的根本在于: 默认情况下，XHR 请求（通过 fetch 或 XMLHttpRequest）是异步且非阻塞的。一旦请求被排队，请求的实际工作就会在幕后交给浏览器级别的 API 处理。")]),t._v(" "),s("p",[t._v("就性能而言，这是很好的设计，毕竟没有占用主线程。但这也意味着存在一种风险，即当页面进入“终止”状态时，在此状态下不会启动新任务，如果正在进行的任务运行时间过长则可能被放弃，"),s("a",{attrs:{href:"https://developer.chrome.com/articles/page-lifecycle-api/#states",target:"_blank",rel:"noopener noreferrer"}},[t._v("没有任何机制保证这些幕后工作会完成"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/chenxiaoyao6228/cloudimg@main/2023/browser-page-lifecycle.png",alt:""}})]),t._v(" "),s("h2",{attrs:{id:"xmlhttprequest-synchronous-flag"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#xmlhttprequest-synchronous-flag"}},[t._v("#")]),t._v(" XMLHttpRequest synchronous flag")]),t._v(" "),s("p",[t._v("实际上，XMLHttpRequest 提供了一个 async 标记，可以将异步请求转化为同步")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" xhr "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XMLHttpRequest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nxhr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("open")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GET"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://api.example.com/data"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 设置 async: false")]),t._v("\nxhr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("p",[t._v("但是不推荐使用，有以下原因：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("浏览器行为：由于安全和性能问题，浏览器通常会限制或忽略 beforeunload 事件期间的异步操作，包括同步 XHR 请求。这是为了防止恶意脚本阻止用户自愿离开页面。")])]),t._v(" "),s("li",[s("p",[t._v("阻塞行为：同步 XHR 请求会阻塞 JavaScript 执行，直到收到响应为止。在 beforeunload 事件期间，浏览器希望事件处理程序能够快速执行，以确保平稳和迅速的卸载过程。")])]),t._v(" "),s("li",[s("p",[t._v("用户体验：阻塞页面的卸载过程可能会导致用户体验不佳，因为用户可能无法迅速离开页面。这可能会导致应用程序感觉不响应，并对用户造成困扰。")])])]),t._v(" "),s("h2",{attrs:{id:"navigator-sendbeacon"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#navigator-sendbeacon"}},[t._v("#")]),t._v(" Navigator.sendBeacon")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon",target:"_blank",rel:"noopener noreferrer"}},[t._v("Navigator.sendBeacon"),s("OutboundLink")],1),t._v(" 方法可用于通过 HTTP POST 将少量数据 异步 传输到 Web 服务器, 主要用于将统计数据发送到 Web 服务器同时避免了用传统技术（如：XMLHttpRequest）发送分析数据的一些问题。")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("navigator"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendBeacon")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nnavigator"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendBeacon")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("p",[t._v("使用 sendBeacon() 方法会使用户代理在有机会时异步地向服务器发送数据，同时不会延迟页面的卸载或影响下一导航的载入性能.")]),t._v(" "),s("p",[t._v("但是有一个比较大的问题:")]),t._v(" "),s("blockquote",[s("p",[t._v("sendBeacon 不支持传递 authorization 等自定义头部")])]),t._v(" "),s("p",[t._v("总结一下，sendBeacon的使用场景")]),t._v(" "),s("ul",[s("li",[t._v("请求比较简单，不需要传递额外的参数")]),t._v(" "),s("li",[t._v("优先级比较低，不需要立即发送")]),t._v(" "),s("li",[t._v("仅需要支持post请求")])]),t._v(" "),s("h2",{attrs:{id:"fetch-keepalive"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#fetch-keepalive"}},[t._v("#")]),t._v(" fetch keepalive")]),t._v(" "),s("p",[t._v("MDN 的介绍简单明了，fetch 的 keepalive 就是用来替换 Navigator.sendBeacon 的")]),t._v(" "),s("blockquote",[s("p",[t._v("The keepalive option can be used to allow the request to outlive the page. Fetch with the keepalive flag is a replacement for the Navigator.sendBeacon() API.")])]),t._v(" "),s("p",[t._v("目前看起来兼容性还行")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/chenxiaoyao6228/cloudimg@main/2023/keep-alive-compability.png",alt:""}})]),t._v(" "),s("p",[t._v("如果需要支持某些老版本的浏览器，可以使用"),s("a",{attrs:{href:"https://github.com/JakeChampion/fetch",target:"_blank",rel:"noopener noreferrer"}},[t._v("polyfill"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("总结一下fetch keepalive的使用场景：")]),t._v(" "),s("ul",[s("li",[t._v("复杂请求比如需要支持自定义请求头")]),t._v(" "),s("li",[t._v("需要支持多种请求方式")])]),t._v(" "),s("h2",{attrs:{id:"参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon")])]),t._v(" "),s("li",[s("p",[t._v("https://developer.mozilla.org/en-US/docs/Web/API/fetch")])]),t._v(" "),s("li",[s("p",[t._v("https://w3c.github.io/beacon/#sec-processing-model")])]),t._v(" "),s("li",[s("p",[t._v("https://css-tricks.com/send-an-http-request-on-page-exit/")])]),t._v(" "),s("li",[s("p",[t._v("https://stackoverflow.com/questions/40523469/navigator-sendbeacon-to-pass-header-information")])])])])}),[],!1,null,null,null);a.default=n.exports}}]);