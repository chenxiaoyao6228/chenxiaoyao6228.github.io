(window.webpackJsonp=window.webpackJsonp||[]).push([[299],{858:function(s,a,e){"use strict";e.r(a);var n=e(7),t=Object(n.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h2",{attrs:{id:"前言"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),e("p",[s._v("痛点：")]),s._v(" "),e("p",[s._v("1）原生的H5，并不能方便地提供类似扫一扫的功能")]),s._v(" "),e("p",[s._v("2）原生H5的扫一扫也需要部署到https")]),s._v(" "),e("p",[s._v("ps：本文基于mac系统，windows用户可以根据思路来进行调整")]),s._v(" "),e("h2",{attrs:{id:"现有方案评估"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#现有方案评估"}},[s._v("#")]),s._v(" 现有方案评估")]),s._v(" "),e("h3",{attrs:{id:"花生壳等内网穿透工具"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#花生壳等内网穿透工具"}},[s._v("#")]),s._v(" 花生壳等内网穿透工具")]),s._v(" "),e("ul",[e("li",[s._v("需要频繁实名验证")]),s._v(" "),e("li",[s._v("花生壳服务商等域名在手机微信内会显示被举报，无法访问")])]),s._v(" "),e("h3",{attrs:{id:"目前的方案"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#目前的方案"}},[s._v("#")]),s._v(" 目前的方案")]),s._v(" "),e("p",[s._v("修改host+charles正向代理+nginx方向代理的模式")]),s._v(" "),e("p",[s._v("原理图如下：\n"),e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/chenxiaoyao6228/cloudimg@main/2019/debug-wechat-through-nginx.png",alt:"image"}})]),s._v(" "),e("h3",{attrs:{id:"基本步骤"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#基本步骤"}},[s._v("#")]),s._v(" 基本步骤")]),s._v(" "),e("p",[s._v("我们可信域名为:\n家长端：mobile-parent.adacampus.com\n教师端：mobile-teacher.adacampus.com")]),s._v(" "),e("ol",[e("li",[s._v("在微信公众号或者企业微信应用主页填写可信域名（已开启）")]),s._v(" "),e("li",[s._v("本地开启服务")]),s._v(" "),e("li",[s._v("修改本地host，把域名解析为本地的服务")]),s._v(" "),e("li",[s._v("安装并配置nginx, 可以成功通过http访问")]),s._v(" "),e("li",[s._v("为nginx配置ssl证书，包括建立CA，CA签名")]),s._v(" "),e("li",[s._v("电脑端安装Charles抓包软件，手机端开启代理并安装Charles证书")])]),s._v(" "),e("h2",{attrs:{id:"本地服务开启"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#本地服务开启"}},[s._v("#")]),s._v(" 本地服务开启")]),s._v(" "),e("p",[s._v("分别开启家长端和教师端在localhost:8080和localhost:8081端口")]),s._v(" "),e("h2",{attrs:{id:"修改host指向"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#修改host指向"}},[s._v("#")]),s._v(" 修改host指向")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/hosts\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("host文件中添加以下几行")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1\tlocalhost\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1\tmobile-teacher.adacampus.com\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1\tmobile-parent.adacampus.com\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("尝试访问: "),e("code",[s._v("http://www.example.com:8080")]),s._v("，"),e("strong",[s._v("(注意尚未开启https)")]),s._v(", 应该能看到页面了,")]),s._v(" "),e("p",[s._v("如果不成，ping一下")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" www.example.com\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1: "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.051")]),s._v(" ms\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1: "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.158")]),s._v(" ms\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h2",{attrs:{id:"nginx反向代理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nginx反向代理"}},[s._v("#")]),s._v(" nginx反向代理")]),s._v(" "),e("p",[s._v("使用nginx来做反向代理，实现"),e("code",[s._v("https://www.mobile-parent.adacampus.com")]),s._v("的访问")]),s._v(" "),e("h3",{attrs:{id:"安装nginx"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装nginx"}},[s._v("#")]),s._v(" 安装nginx")]),s._v(" "),e("p",[s._v("官网："),e("a",{attrs:{href:"https://www.nginx.com/resources/wiki/start/topics/tutorials/install/",target:"_blank",rel:"noopener noreferrer"}},[s._v("nginx安装"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("取决于系统以及安装过程，配置文件大概在以下几个位置")]),s._v(" "),e("blockquote",[e("p",[s._v("/usr/local/nginx/conf, /etc/nginx或者 /usr/local/etc/nginx")])]),s._v(" "),e("h3",{attrs:{id:"生成ssl证书"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#生成ssl证书"}},[s._v("#")]),s._v(" 生成ssl证书")]),s._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/FiloSottile/mkcert/blob/master/README.md#supported-root-stores",target:"_blank",rel:"noopener noreferrer"}},[s._v("安装mkcert"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("cd到"),e("code",[s._v("nginx")]),s._v("安装目录的的"),e("code",[s._v("ssl")]),s._v("文件夹目录下")]),s._v(" "),e("p",[s._v("分别运行")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("mkcert -key-file key.pem -cert-file cert.pem mobile-parent.adacampus.com mobile-parent.adacampus.com\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("mkcert -key-file key.pem -cert-file cert.pem mobile-teacher.adacampus.com mobile-teacher.adacampus.com\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("出现下列信息就ok了")]),s._v(" "),e("blockquote",[e("p",[s._v("Created a new certificate valid for the following names 📜")])]),s._v(" "),e("ul",[e("li",[s._v('"mobile-parent.adacampus.com"')]),s._v(" "),e("li",[s._v('"mobile-parent.adacampus.com"')])]),s._v(" "),e("p",[s._v('The certificate is at "cert.pem" and the key at "key.pem" ✅')]),s._v(" "),e("h3",{attrs:{id:"nginx配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nginx配置"}},[s._v("#")]),s._v(" nginx配置")]),s._v(" "),e("p",[s._v("配置文件示例，家长端和教师端分别对应"),e("code",[s._v("8080")]),s._v("和"),e("code",[s._v("8081")])]),s._v(" "),e("div",{staticClass:"language-nginx.conf line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nworker_processes  1;\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    include       mime.types;\n    default_type  application/octet-stream;\n    sendfile        on;\n    #tcp_nopush     on;\n\n    #keepalive_timeout  0;\n    keepalive_timeout  65;\n\n    #gzip  on;\n    \n    # HTTPS server\n    \n    server {\n       listen       443 ssl;\n       server_name  mobile-parent.adacampus.com;\n       proxy_buffering off;\n\n       ssl_certificate      /usr/local/etc/nginx/ssl/mobile-parent.adacampus.com.pem;\n       ssl_certificate_key  /usr/local/etc/nginx/ssl/mobile-parent.adacampus.com-key.pem;\n\n       ssl_session_cache    shared:SSL:1m;\n       ssl_session_timeout  5m;\n\n       ssl_ciphers  HIGH:!aNULL:!MD5;\n       ssl_prefer_server_ciphers  on;\n\n       location / {\n           root   html;\n           index  index.html index.htm;\n           proxy_pass          http://localhost:8080;\n       }\n    }\n\n    server {\n       listen       443 ssl;\n       server_name  mobile-teacher.adacampus.com;\n       proxy_buffering off;\n\n       ssl_certificate      /usr/local/etc/nginx/ssl/mobile-teacher.adacampus.com.pem;\n       ssl_certificate_key  /usr/local/etc/nginx/ssl/mobile-teacher.adacampus.com-key.pem;\n\n       ssl_session_cache    shared:SSL:1m;\n       ssl_session_timeout  5m;\n\n       ssl_ciphers  HIGH:!aNULL:!MD5;\n       ssl_prefer_server_ciphers  on;\n\n       location / {\n           root   html;\n           index  index.html index.htm;\n           proxy_pass          http://localhost:8081;\n       }\n    }\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br")])]),e("p",[s._v("在浏览器中输入"),e("code",[s._v("https://www.mobile-parent.adacampus.com")]),s._v("，如果浏览器没有提示安全警告⚠️的话，就ok了")]),s._v(" "),e("h2",{attrs:{id:"配置charles"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置charles"}},[s._v("#")]),s._v(" 配置charles")]),s._v(" "),e("p",[s._v("需要分别在电脑和手机端安装charles证书， 具体可以参考"),e("a",{attrs:{href:"https://juejin.cn/post/6844904106255974413",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("完成之后，在手机微信上访问，"),e("code",[s._v("https://www.mobile-parent.adacampus.com")]),s._v("，如果能够抓包，那就证明可以成功访问电脑上开启的本地服务了")]),s._v(" "),e("h3",{attrs:{id:"踩坑汇总"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#踩坑汇总"}},[s._v("#")]),s._v(" 踩坑汇总")]),s._v(" "),e("p",[s._v("把server文件夹下的东西作为配置文件了，所以无法识别\n"),e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/chenxiaoyao6228/cloudimg@main/2019/debug-wechat-with-nginx-2.png",alt:"image.png"}})]),s._v(" "),e("p",[e("a",{attrs:{href:"https://stackoverflow.com/questions/46127025/nginx-https-server-barfing-on-crt-and-key-files",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://stackoverflow.com/questions/46127025/nginx-https-server-barfing-on-crt-and-key-files"),e("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=t.exports}}]);